# SQL编码规范文档

## 概述
本文档旨在为数据库编写语句提供详细的开发规范和指导，对于MySQL和Oracle存在差异的部分给出分支说明差异。

## 物理模型和物理表设计规范
- 数据模型设计规范：
1. 在已知表名设计数据模型时，先访问 MCP 服务传入表名获取表结构信息，如果返回的表结构信息不为空，这根据返回的表结构信息进行创建相应的数据模型
2. 如果 MCP 服务返回的表结构信息为空，再按照下面的步骤进行设计。

- 标准元素定义：
1. 标准元素由 MCP 返回，包含以下信息：
      英文名称
      中文名称
      字段名称
      数据类型
      长度
      精度
2. 注意：获取标准元素传入的是中文信息

- 物理表字段设计规范：
1. 物理表的字段名来源于标准元素的字段名称，物理表的字段类型来源于标准元素的数据类型，物理表的字段长度和精度来源于标准元素的长度和精度
2. 无对应标准元素时，采用行业标准进行设计
3. 禁止字段名重复
  
- 数据模型设计规范：
1. 数据模型对象的属性来源于标准元素的英文名称
2. 无对应标准元素时，采用行业标准

- 严格按照此流程进行设计：
1. 先按行业标准设计物理表结构和数据模型
2. 输出按行业标准设计的物理表
3. 获取标准元素：将按行业标准设计的物理表所有字段的中文信息调用mcp服务获取相应的标准元素信息（一定要调用，直接调用不需要询问是否需要调用）
4. 字段对比：将按行业标准设计的物理表的所有字段对比标准元素，更新物理表信息：物理表的字段名来源于标准元素的字段名称，物理表的字段类型来源于标准元素的数据类型，物理表的字段长度和精度来源于标准元素的长度和精度。
- 注意：
- 获取标准元素时直接调用mcp服务获取，直接调用，直接调用，直接调用。
- 如果按行业标准设计的物理表字段在标准元素里面找不到，则需保留按行业标准设计的物理表字段不允许删除，也不准再次调用mcp获取标准元素
5. 输出对比更新后的物理表，一定要输出
6. 最终确保：
  物理表的字段名来源于标准元素的字段名称，物理表的字段类型来源于标准元素的数据类型，物理表的字段长度和精度来源于标准元素的长度和精度
  数据模型对象的属性来源于标准元素的英文名称

- 特别特别要求：
1. 最终输出的物理表字段和数据模型属性必须源于标准元素:物理表的字段名来源于标准元素的字段名称，物理表的字段类型来源于标准元素的数据类型，物理表的字段长度和精度来源于标准元素的长度和精度,数据模型对象的属性来源于标准元素的英文名称（若英文名称不是小写驼峰形式，需转换为小写驼峰形式）

- 其他要求
1. PO类采用JPA注解方式，与数据库表结构完全对应
2. 使用@Entity和@Table注解标识为JPA实体
3. 每个字段都有@Column注解，明确指定数据库映射关系

## 代码风格规范
### 格式与排版
- **关键字大写**：SQL关键字（SELECT/UPDATE/DELETE等）、保留字必须全大写，存储字符除外。
- **空格与符号规范**：
  - 关键字前后加空格（`WHERE C1=1`）
  - 括号前后加空格（`LEFT (C1, 2)`）
  - `=`、`>=`、`<=`、`,` 等符号前后不加空格
- **缩进与换行**：
  - 缩进使用2个空格，禁用Tab
  - SELECT/FROM/WHERE/AND 等子句另起一行，条件对齐
- **语句长度限制**：单条SQL长度不应超过4K(4096个字节)
- **禁止全角字符**：SQL语句体禁止包含全角字符（除中文字符串外）

### 命名规范
- **别名规范**：
  - 多表关联必须使用别名（`A.C1`）
  - 别名不超过2字符
  - 禁止别名重复
- **保留字命名**：表名、列名禁止使用数据库保留字（如 `DATE`, `USER`）
- **分页表命名**：分页表以 `QT_` 开头

### 注释规范
- **复杂逻辑添加注释**：使用单行 `--` 或多行 `/* */`
- **注释内容**：需说明算法、功能、变量含义及合法取值范围

## 查询优化规范
### 基本查询优化
- **禁止使用 SELECT ***：明确列出所需字段
- **绑定变量**：尽量使用绑定变量（预处理语句）提升SQL复用性
- **关联表数量上限**：单条SQL关联表数量不得超过5个
- **IN列表限制**：
  - 列表值少于10个用 `IN(1,2,3)`
  - 列表值10-100 用递归子查询转行
  ```sql
     SELECT T1.C_ID 
        ROM T1, 
           (SELECT REGEXP_SUBSTR('1,2,3,4,5,6,7,8,9,10,11','[^,]+',1,LEVEL) AS C_ID 
              FROM DUAL
           CONNECT BY LEVEL<=11) T_TMP
      WHERE T1.C_ID=T_TMP.C_ID;
  ```
  - 列表值超过100个时，先插入临时表再关联
- **IN子查询限制**：Mysql 数据库，禁止索引列使用IN 子查询过滤。
  

### 索引使用规范
- **索引列禁用函数**：索引列增加函数转换会导致索引失效
- **索引列函数替代方案**：避免使用函数（如 `SUBSTR(C1,1,2)`），改用 `LIKE 'XX%'`
- **禁止隐式转换**：字段与常量比较时应该对常量强制做类型转换，避免隐式类型转换（如 `C_CHAR=123`）
- **禁止全表扫描**：查询语句必须走索引过滤，修改、删除必须走主键过滤。

### JOIN优化
- **多表关联编写顺序**：以交叉表（被引用的表）放最前面，然后将表按数据量从多到少顺序排列
- **避免嵌套连接**：例如：`B=A AND C=B AND D=C`，应该写成：`B=A AND C=A AND D=A`
- **JOIN类型选择**：
  - 优先使用 INNER JOIN
  - 禁止使用无效的 LEFT JOIN,如外关连表增加过滤条件。
  - 禁止使用 FULL JOIN，改用 UNION 实现

### 排序与分组优化
- **减少 ORDER BY 和 GROUP BY 使用**：避免全表排序
- **DISTINCT替代**：使用 GROUP BY 替代 DISTINCT

### 子查询与视图优化
- **禁止等值子查询**：对于嵌套等值子查询，分步提取结果后使用变量
- **禁止NOT IN子查询**：改用外连接（LEFT JOIN + IS NULL）
- **子查询层级限制**：子查询的层级不能超过3层
- **禁止视图关联**：优先用表代替
- **WITH子句优化**：WITH子查询避免重复使用，复杂逻辑拆解为多步

## 数据操作规范

### 数据插入规范
- **时间写入规范**：使用数据库时间函数而非业务时间
  - MySQL使用`NOW()`
  - Oracle使用`SYSDATE()`
- **字符空值处理**：
  - 插入空值用 NULL，禁用空字符串 `''`
  - 查询空值用 IS NULL，禁用 `= ''`

### 数据更新与删除规范
- **禁止全量删除/更新普通表**：禁止事实表不带条件的更新和删除操作，`DELETE FROM T1` 或 `UPDATE T1 SET C1=C1`，全局临时表除外(GT_或TEMP_开头的表)。
- **禁止TRUNCATE普通表**：禁止事实表做TRUNCATE 操作，全局临时表除外(GT_或TEMP_开头的表)

## 特殊功能规范

### 临时表使用规范
- **禁止创建固定表当作中间临时表**
- **临时表创建差异**：
  - MySQL允许使用 `CREATE TEMPORARY TABLE` 创建临时表
  - Oracle不允许代码中创建临时表
- **临时表管理**：
  - 使用前需清理，避免脏数据
  - 使用完成后要做回收
    - MySQL使用`DROP TEMPORARY TABLE`方式回收
    - Oracle使用`TRUNCATE`方式回收

### 分页查询规范
- **记录数限制**：单次返回记录数不得超过1000行
- **分页表操作限制**：仅允许插入操作
- **关联查询优化**：
  - 需通过主键关联维表，禁止通过关联表过滤
  - 大偏移分页时优先通过主键关联

### 分区表使用规范
- **分区修剪**：查询分区表时必须通过过滤键值进行分区修剪（如 `WHERE C_YEAR=2023`）
- **关联优化**：多表关联时确保分区列参与过滤

### Oracle特有规范
- **MERGE INTO使用规范**：
  - 禁止独立NOT MATCHED子句，不建议独立使用WHEN NOT MATCHED
  - 禁止扩展DELETE操作，WHEN MATCHED子句UPDATE后禁止DELETE扩展操作
  - 禁止外关联写法，在ON子句中禁止外关联语法
  - 禁止WHERE条件过滤，建议将过滤条件增加到ON子句中

## 禁止事项
- **禁止动态拼接恒等式**：不允许拼接 `WHERE 1=1` 类似的恒等条件
- **禁止自定义函数DML**：函数中禁止包含增删改操作（INSERT/UPDATE/DELETE）
- **禁止使用业务代码记录日志**：业务代码不允许使用ECP_SQL_TRACE表记录日志
- **禁止自定义函数**：查询列和过滤值中禁止自定义函数
