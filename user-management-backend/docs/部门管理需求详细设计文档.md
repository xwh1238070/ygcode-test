# 部门管理需求详细设计文档

## 1. 需求概述

### 1.1 项目背景
为用户管理系统扩展部门管理功能，实现部门的全生命周期管理，支持树形层级结构，并与现有用户管理功能深度集成。

### 1.2 业务场景
- 系统管理员进行部门管理
- 支持多级部门层级结构（最多5级）
- 支持部门的增删改查操作
- 支持批量操作（删除、启用、禁用）
- 与用户管理集成，支持部门人员统计

### 1.3 技术栈
- **框架**: Spring Boot 2.x
- **JDK**: 1.8
- **数据库**: MySQL 5.7+
- **数据访问**: JPA + ORMap 框架
- **API 文档**: Swagger

## 2. 功能点分析

### 2.1 核心功能

#### 2.1.1 查询功能
- **部门列表查询**: 支持分页、多条件组合查询
  - 部门名称模糊查询
  - 部门编码精确查询
  - 父部门筛选
  - 状态筛选（启用/禁用）
  - 层级筛选
- **部门树形结构查询**: 获取完整的部门树形结构
- **部门总数查询**: 获取符合条件的部门总数
- **部门详情查询**: 根据部门ID查询详细信息
- **子部门查询**: 查询指定部门的直接子部门
- **部门用户统计**: 统计每个部门的用户数量

#### 2.1.2 数据管理功能
- **新增部门**: 创建新部门，支持设置父部门
- **编辑部门**: 更新部门基本信息
- **删除部门**: 物理删除部门，支持批量删除

#### 2.1.3 部门操作功能
- **启用部门**: 将部门状态设置为启用，支持批量操作
- **禁用部门**: 将部门状态设置为禁用，支持批量操作

### 2.2 功能优先级
1. **P0（高优先级）**: 查询、新增、编辑、删除、树形结构
2. **P1（中优先级）**: 启用、禁用、用户统计
3. **P2（低优先级）**: 导入、导出（后续扩展）

## 3. 数据库设计

### 3.1 部门表（TBL_DEPARTMENT）

#### 3.1.1 表结构

| 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 说明 |
|--------|---------|------|------|---------|---------|--------|------|
| C_DEPT_ID | VARCHAR | 20 | - | 是 | 否 | - | 部门ID，主键 |
| C_DEPT_CODE | VARCHAR | 50 | - | 否 | 否 | - | 部门编码，唯一 |
| C_DEPT_NAME | VARCHAR | 100 | - | 否 | 否 | - | 部门名称 |
| C_PARENT_ID | VARCHAR | 20 | - | 否 | 是 | - | 父部门ID |
| C_DEPT_LEVEL | INT | - | - | 否 | 否 | 1 | 部门层级（1为顶级） |
| C_DEPT_PATH | VARCHAR | 500 | - | 否 | 是 | - | 部门路径 |
| C_SORT_ORDER | INT | - | - | 否 | 否 | 0 | 排序号 |
| C_LEADER | VARCHAR | 50 | - | 否 | 是 | - | 部门负责人 |
| C_PHONE | VARCHAR | 20 | - | 否 | 是 | - | 联系电话 |
| C_EMAIL | VARCHAR | 100 | - | 否 | 是 | - | 邮箱 |
| C_STATUS | VARCHAR | 1 | - | 否 | 否 | '1' | 状态：1-启用，0-禁用 |
| C_DESCRIPTION | VARCHAR | 500 | - | 否 | 是 | - | 部门描述 |
| C_CREATE_TIME | DATETIME | - | - | 否 | 否 | CURRENT_TIMESTAMP | 创建时间 |
| C_UPDATE_TIME | DATETIME | - | - | 否 | 是 | - | 更新时间 |
| C_CREATOR | VARCHAR | 50 | - | 否 | 是 | - | 创建人 |
| C_UPDATER | VARCHAR | 50 | - | 否 | 是 | - | 更新人 |

#### 3.1.2 索引设计

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| PK_DEPARTMENT | PRIMARY KEY | C_DEPT_ID | 主键索引 |
| UK_DEPT_CODE | UNIQUE | C_DEPT_CODE | 部门编码唯一索引 |
| IDX_PARENT_ID | INDEX | C_PARENT_ID | 父部门索引 |
| IDX_STATUS | INDEX | C_STATUS | 状态索引 |
| IDX_DEPT_LEVEL | INDEX | C_DEPT_LEVEL | 层级索引 |

#### 3.1.3 建表 SQL

```sql
CREATE TABLE TBL_DEPARTMENT (
    C_DEPT_ID VARCHAR(20) NOT NULL COMMENT '部门ID',
    C_DEPT_CODE VARCHAR(50) NOT NULL COMMENT '部门编码',
    C_DEPT_NAME VARCHAR(100) NOT NULL COMMENT '部门名称',
    C_PARENT_ID VARCHAR(20) COMMENT '父部门ID',
    C_DEPT_LEVEL INT NOT NULL DEFAULT 1 COMMENT '部门层级',
    C_DEPT_PATH VARCHAR(500) COMMENT '部门路径',
    C_SORT_ORDER INT NOT NULL DEFAULT 0 COMMENT '排序号',
    C_LEADER VARCHAR(50) COMMENT '部门负责人',
    C_PHONE VARCHAR(20) COMMENT '联系电话',
    C_EMAIL VARCHAR(100) COMMENT '邮箱',
    C_STATUS VARCHAR(1) NOT NULL DEFAULT '1' COMMENT '状态：1-启用，0-禁用',
    C_DESCRIPTION VARCHAR(500) COMMENT '部门描述',
    C_CREATE_TIME DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    C_UPDATE_TIME DATETIME COMMENT '更新时间',
    C_CREATOR VARCHAR(50) COMMENT '创建人',
    C_UPDATER VARCHAR(50) COMMENT '更新人',
    PRIMARY KEY (C_DEPT_ID),
    UNIQUE KEY UK_DEPT_CODE (C_DEPT_CODE),
    KEY IDX_PARENT_ID (C_PARENT_ID),
    KEY IDX_STATUS (C_STATUS),
    KEY IDX_DEPT_LEVEL (C_DEPT_LEVEL)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部门表';

-- 插入测试数据
INSERT INTO TBL_DEPARTMENT (C_DEPT_ID, C_DEPT_CODE, C_DEPT_NAME, C_PARENT_ID, C_DEPT_LEVEL, C_DEPT_PATH, C_SORT_ORDER, C_LEADER, C_PHONE, C_EMAIL, C_STATUS, C_DESCRIPTION, C_CREATE_TIME, C_CREATOR) VALUES
('D001', 'DEPT001', '总公司', NULL, 1, '/D001', 1, '张总', '13800000001', 'ceo@company.com', '1', '公司总部', NOW(), 'system'),
('D002', 'DEPT002', '技术部', 'D001', 2, '/D001/D002', 1, '李经理', '13800000002', 'tech@company.com', '1', '技术研发部门', NOW(), 'system'),
('D003', 'DEPT003', '市场部', 'D001', 2, '/D001/D003', 2, '王经理', '13800000003', 'market@company.com', '1', '市场营销部门', NOW(), 'system'),
('D004', 'DEPT004', '研发一组', 'D002', 3, '/D001/D002/D004', 1, '赵组长', '13800000004', 'dev1@company.com', '1', '研发第一组', NOW(), 'system'),
('D005', 'DEPT005', '研发二组', 'D002', 3, '/D001/D002/D005', 2, '钱组长', '13800000005', 'dev2@company.com', '1', '研发第二组', NOW(), 'system');
```

### 3.2 数据模型设计

#### 3.2.1 DepartmentPO（持久化对象）

```java
@Entity
@Table(name = "TBL_DEPARTMENT")
public class DepartmentPO {
    @Id
    @Column(name = "C_DEPT_ID", length = 20)
    private String deptId;
    
    @Column(name = "C_DEPT_CODE", length = 50, nullable = false, unique = true)
    private String deptCode;
    
    @Column(name = "C_DEPT_NAME", length = 100, nullable = false)
    private String deptName;
    
    @Column(name = "C_PARENT_ID", length = 20)
    private String parentId;
    
    @Column(name = "C_DEPT_LEVEL", nullable = false)
    private Integer deptLevel;
    
    @Column(name = "C_DEPT_PATH", length = 500)
    private String deptPath;
    
    @Column(name = "C_SORT_ORDER", nullable = false)
    private Integer sortOrder;
    
    @Column(name = "C_LEADER", length = 50)
    private String leader;
    
    @Column(name = "C_PHONE", length = 20)
    private String phone;
    
    @Column(name = "C_EMAIL", length = 100)
    private String email;
    
    @Column(name = "C_STATUS", length = 1, nullable = false)
    private String status;
    
    @Column(name = "C_DESCRIPTION", length = 500)
    private String description;
    
    @Column(name = "C_CREATE_TIME", nullable = false)
    private Date createTime;
    
    @Column(name = "C_UPDATE_TIME")
    private Date updateTime;
    
    @Column(name = "C_CREATOR", length = 50)
    private String creator;
    
    @Column(name = "C_UPDATER", length = 50)
    private String updater;
    
    // getter/setter 省略
}
```

#### 3.2.2 DepartmentBO（业务对象）

```java
public class DepartmentBO {
    private String deptId;
    private String deptCode;
    private String deptName;
    private String parentId;
    private Integer deptLevel;
    private String deptPath;
    private Integer sortOrder;
    private String leader;
    private String phone;
    private String email;
    private String status;
    private String description;
    private Date createTime;
    private Date updateTime;
    private String creator;
    private String updater;
    
    // getter/setter 省略
}
```

#### 3.2.3 DepartmentVO（视图对象）

```java
public class DepartmentVO {
    private String deptId;
    private String deptCode;
    private String deptName;
    private String parentId;
    private String parentName;      // 父部门名称
    private Integer deptLevel;
    private Integer sortOrder;
    private String leader;
    private String phone;
    private String email;
    private String status;
    private String statusText;      // 状态文本（启用/禁用）
    private String description;
    private String createTime;      // 格式化后的字符串
    private Integer userCount;      // 部门用户数量
    
    // getter/setter 省略
}
```

#### 3.2.4 DepartmentTreeVO（树形结构对象）

```java
public class DepartmentTreeVO {
    private String deptId;
    private String deptCode;
    private String deptName;
    private String parentId;
    private Integer deptLevel;
    private Integer sortOrder;
    private String status;
    private Integer userCount;
    private List<DepartmentTreeVO> children;  // 子部门列表
    
    // getter/setter 省略
}
```

#### 3.2.5 DepartmentQueryVO（查询条件对象）

```java
public class DepartmentQueryVO {
    private String deptName;        // 部门名称（模糊查询）
    private String deptCode;        // 部门编码（精确查询）
    private String parentId;        // 父部门ID
    private String status;          // 状态
    private Integer deptLevel;      // 部门层级
    private Integer pageSize;       // 每页大小
    private Integer pageIndex;      // 页码
    
    // getter/setter 省略
}
```

#### 3.2.6 DepartmentBatchVO（批量操作对象）

```java
public class DepartmentBatchVO {
    private List<String> deptIds;  // 部门ID列表
    
    // getter/setter 省略
}
```

## 4. 接口设计

### 4.1 接口基础信息

- **基础路径**: `{securitydomain}/{vipaddress}/{读写分离标识}/model/department/`
- **安全域**: `member`（前端应用调用）
- **返回格式**: `CommonResult<T>`

### 4.2 接口列表

#### 4.2.1 查询部门列表

**接口地址**: `/list`  
**请求方式**: POST  
**接口说明**: 分页查询部门列表，支持多条件组合查询

**请求参数**:
```json
{
  "deptName": "技术部",
  "deptCode": "DEPT001",
  "parentId": "D001",
  "status": "1",
  "deptLevel": 2,
  "pageSize": 20,
  "pageIndex": 1
}
```

**响应参数**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "deptId": "D002",
      "deptCode": "DEPT002",
      "deptName": "技术部",
      "parentId": "D001",
      "parentName": "总公司",
      "deptLevel": 2,
      "sortOrder": 1,
      "leader": "李经理",
      "phone": "13800000002",
      "email": "tech@company.com",
      "status": "1",
      "statusText": "启用",
      "description": "技术研发部门",
      "createTime": "2024-01-15 10:30:00",
      "userCount": 15
    }
  ]
}
```

#### 4.2.2 查询部门树形结构

**接口地址**: `/tree`  
**请求方式**: POST  
**接口说明**: 获取完整的部门树形结构

**请求参数**:
```json
{
  "status": "1"
}
```

**响应参数**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "deptId": "D001",
      "deptCode": "DEPT001",
      "deptName": "总公司",
      "parentId": null,
      "deptLevel": 1,
      "sortOrder": 1,
      "status": "1",
      "userCount": 50,
      "children": [
        {
          "deptId": "D002",
          "deptCode": "DEPT002",
          "deptName": "技术部",
          "parentId": "D001",
          "deptLevel": 2,
          "sortOrder": 1,
          "status": "1",
          "userCount": 15,
          "children": []
        }
      ]
    }
  ]
}
```

#### 4.2.3 获取部门总数

**接口地址**: `/count`  
**请求方式**: POST  
**接口说明**: 获取符合查询条件的部门总数

**请求参数**: 同查询条件

**响应参数**:
```json
{
  "code": 0,
  "message": "success",
  "data": 50
}
```

#### 4.2.4 获取部门详情

**接口地址**: `/detail`  
**请求方式**: POST  
**接口说明**: 根据部门ID查询部门详细信息

**请求参数**:
```json
{
  "deptId": "D001"
}
```

**响应参数**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "deptId": "D001",
    "deptCode": "DEPT001",
    "deptName": "总公司",
    "parentId": null,
    "parentName": null,
    "deptLevel": 1,
    "sortOrder": 1,
    "leader": "张总",
    "phone": "13800000001",
    "email": "ceo@company.com",
    "status": "1",
    "statusText": "启用",
    "description": "公司总部",
    "createTime": "2024-01-15 10:30:00",
    "userCount": 50
  }
}
```

#### 4.2.5 新增部门

**接口地址**: `/add`  
**请求方式**: POST  
**接口说明**: 创建新部门

**请求参数**:
```json
{
  "deptCode": "DEPT006",
  "deptName": "人力资源部",
  "parentId": "D001",
  "sortOrder": 3,
  "leader": "孙经理",
  "phone": "13800000006",
  "email": "hr@company.com",
  "description": "人力资源管理部门"
}
```

**响应参数**:
```json
{
  "code": 0,
  "message": "success",
  "data": "D006"
}
```

#### 4.2.6 编辑部门

**接口地址**: `/edit`  
**请求方式**: POST  
**接口说明**: 更新部门信息

**请求参数**:
```json
{
  "deptId": "D002",
  "deptName": "技术研发部",
  "sortOrder": 1,
  "leader": "李经理",
  "phone": "13800000002",
  "email": "tech@company.com",
  "description": "技术研发部门"
}
```

**响应参数**:
```json
{
  "code": 0,
  "message": "success",
  "data": true
}
```

#### 4.2.7 删除部门

**接口地址**: `/delete`  
**请求方式**: POST  
**接口说明**: 删除部门，支持批量删除

**请求参数**:
```json
{
  "deptIds": ["D004", "D005"]
}
```

**响应参数**:
```json
{
  "code": 0,
  "message": "success",
  "data": 2
}
```

#### 4.2.8 启用部门

**接口地址**: `/enable`  
**请求方式**: POST  
**接口说明**: 启用部门，支持批量操作

**请求参数**:
```json
{
  "deptIds": ["D002", "D003"]
}
```

**响应参数**:
```json
{
  "code": 0,
  "message": "success",
  "data": 2
}
```

#### 4.2.9 禁用部门

**接口地址**: `/disable`  
**请求方式**: POST  
**接口说明**: 禁用部门，支持批量操作

**请求参数**:
```json
{
  "deptIds": ["D002", "D003"]
}
```

**响应参数**:
```json
{
  "code": 0,
  "message": "success",
  "data": 2
}
```

#### 4.2.10 查询子部门

**接口地址**: `/children`  
**请求方式**: POST  
**接口说明**: 查询指定部门的直接子部门

**请求参数**:
```json
{
  "parentId": "D001"
}
```

**响应参数**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "deptId": "D002",
      "deptCode": "DEPT002",
      "deptName": "技术部",
      "parentId": "D001",
      "deptLevel": 2,
      "sortOrder": 1,
      "status": "1",
      "userCount": 15
    }
  ]
}
```

#### 4.2.11 统计部门用户数量

**接口地址**: `/userCount`  
**请求方式**: POST  
**接口说明**: 统计指定部门的用户数量

**请求参数**:
```json
{
  "deptId": "D001"
}
```

**响应参数**:
```json
{
  "code": 0,
  "message": "success",
  "data": 50
}
```

## 5. 业务规则

### 5.1 部门编码规则
- 长度：3-50 个字符
- 格式：字母、数字、下划线
- 唯一性：系统内唯一

### 5.2 部门层级规则
- 最大层级：5级
- 顶级部门：层级为1，parentId为NULL
- 子部门：层级 = 父部门层级 + 1

### 5.3 部门路径规则
- 格式：`/父路径/当前部门ID`
- 示例：`/D001/D002/D004`
- 自动维护，不允许手动修改

### 5.4 状态规则
- `1`：启用
- `0`：禁用
- 新增部门默认启用

### 5.5 部门ID生成规则
- 格式：`D` + 时间戳（13位） + 随机数（3位）
- 示例：`D1702627200001123`

### 5.6 删除规则
- 有子部门时不允许删除
- 有关联用户时不允许删除
- 删除前需要检查依赖关系

### 5.7 批量操作规则
- 最大批量数：100
- 失败策略：部分失败继续执行，返回成功和失败数量

### 5.8 排序规则
- 同级部门按 sortOrder 升序排列
- sortOrder 相同时按创建时间排序

## 6. 与用户管理的集成

### 6.1 数据关联
- 用户表的 `C_DEPARTMENT_ID` 关联到部门表的 `C_DEPT_ID`
- 用户表的 `C_DEPARTMENT` 字段存储部门名称（冗余字段）

### 6.2 级联更新
- 部门名称修改时，同步更新用户表中的部门名称
- 部门删除时，检查是否有关联用户

### 6.3 统计功能
- 部门详情查询时，返回该部门的用户数量
- 部门列表查询时，可选择是否包含用户数量统计

## 7. 异常处理

### 7.1 错误码定义

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 2001 | 部门编码已存在 |
| 2002 | 部门不存在 |
| 2003 | 部门编码格式不正确 |
| 2004 | 必填字段为空 |
| 2005 | 批量操作数量超限 |
| 2006 | 部门层级超过限制 |
| 2007 | 父部门不存在 |
| 2008 | 部门下有子部门，不允许删除 |
| 2009 | 部门下有用户，不允许删除 |
| 9999 | 系统异常 |

### 7.2 异常处理策略
- 参数验证异常：返回错误码和提示信息
- 业务异常：返回错误码和提示信息
- 系统异常：记录日志，返回通用错误信息

## 8. 性能要求

### 8.1 响应时间
- 查询接口：< 500ms
- 树形结构查询：< 1s
- 新增/编辑：< 300ms
- 批量操作：< 2s

### 8.2 并发要求
- 支持 100 并发用户
- 查询 QPS：500+

### 8.3 数据量
- 预计部门数：1000+
- 单次查询最大返回：1000 条

## 9. 安全要求

### 9.1 SQL 注入防护
- 使用绑定变量
- 参数验证

### 9.2 权限控制
- 接口需要登录认证
- 操作需要权限验证

## 10. 测试要点

### 10.1 功能测试
- 所有接口的正常流程
- 树形结构构建正确性
- 部门路径自动维护
- 边界值测试
- 异常流程测试

### 10.2 性能测试
- 并发测试
- 压力测试
- 大数据量测试

### 10.3 安全测试
- SQL 注入测试
- 参数验证测试
- 权限测试

## 11. 部署说明

### 11.1 环境要求
- JDK 1.8+
- MySQL 5.7+
- Maven 3.6+

### 11.2 配置项
- 数据库连接
- 最大层级限制
- 批量操作限制
- 日志级别

### 11.3 初始化
- 执行建表 SQL
- 创建初始部门数据

---

**文档版本**: v1.0  
**编写日期**: 2024-12-15  
**编写人**: 系统架构师
