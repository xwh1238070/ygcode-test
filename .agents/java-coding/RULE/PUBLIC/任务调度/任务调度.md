# 调度组件使用指南

## 1. 组件概述

调度组件用于配置和管理定时任务，支持基于时间的调度和基于次数的调度。通过简单的配置，可以实现任务的自动执行，无需手动干预。

## 2. 依赖引入

在项目的pom.xml文件中添加以下依赖：

```
<dependency>
    <groupId>com.ygsoft.jt.teng</groupId>
    <artifactId>teng.cp.scheduler.quartz</artifactId>
    <version>${jt.version}</version>
</dependency>
```

## 3. 配置说明

调度任务通过JSON配置文件进行管理。配置文件路径为：`/META-INF/ecp-scheduler/ecp.scheduler.json`。

一个配置文件可以配置多个调度任务，JSON格式为`[{},{},{}]`。

> **注意**：JSON不支持注释，实际使用时请勿直接复制带有注释的示例代码。

## 4. 配置示例

```
[
  {
    "jobGroup": "testGroup", //任务分组，对任务分类,显示给用户看的
    "jobName": "MyTaskIEcpJob", //任务名称，与调度任务类名一致，显示给用户看的
    "jobClass": "com.ygsoft.ecp.component.scheduler.task.AnalysisTask", // 任务逻辑所在类的全路径或bean名称, 如有注入属性，必须做bean名称，任务类型为本地类方法时使用
    "jobMethod": "analysis", //任务类型为本地类方法时，定义任务逻辑所在类的方法,应具有JobExecutionContext类型的参数。任务类型为远程请求时，定义httpmethod，即get、post等
    "jobUrl":"", //HTTP地址，任务类型为远程请求时使用
    "vipAddress": "/jt/mapp/sample",  //vipAddress地址，与配置文件中的配置中心的application name保持一致例如 jt.mapp.sample，则写为/jt/mapp/sample
    "jobDesc": "调度测试-类及方法",
    "cronExpression": "", //调度时间，这个是cron表达式，网上找一下说明。 如果该任务是程序内置调度任务则指定cronExpression，如果是给实施地配置的就不用指定cronExpression, 内置的调度任务不可以通过界面配置
    "startTime": "2020-03-20", //开始时间,JDK1.8下月份日期保留两位
    "endTime": "2022-03-20", //结束时间,JDK1.8下月份日期保留两位
    "priority": "9", //优先级，1-10， 10最高
    "startDelay": "0", //启动延时,单位秒
    "repeatCount": "0", //触发次数，与cronExpression互斥（即二选一），即任务要么定义为定时触发，要么定义为共触发多少次
    "repeatInterval": "2000", //触发时间间隔,与repeatCount配合使用，单位毫秒
    "jobParameter":"", //远程请求时的post body参数
    "jobDataMap":"",//任务自定义参数，注意***该项没有值时请务必去掉该项****，任务类型为本地类方法时使用，3.0及以下版本使用, Map对象的json表示,最终会传入JobExecutionContext
    "jobDataDef": //任务自定义参数，3.0以上版本使用,供实施地通过界面自定义参数，运行时会提取name与value转换为jodDataMap使用
      {
        "name": "name", //参数名称
        "type": "字符", //参数类型,目前有字符、数字、时间几种
        "value": "张三", //参数默认值
        "desc": "名称"  //参数说明
      },
     //"isCancel": "true" //是否删除标识，设置true时，会把上报的组件和调度任务删除 （V810以后版本）
     //"jobParameter": "min=true" //支持设置分钟调度，此参数慎重添加，需要部门经理审批后才能使用
 }
]
```

## 5. 配置参数说明

| 参数名 | 说明 | 是否必填 | 示例值 |
|--------|------|----------|--------|
| jobGroup | 任务分组，用于对任务分类，显示给用户看 | 是 | "testGroup" |
| jobName | 任务名称，与调度任务类名一致，显示给用户看 | 是 | "MyTaskIEcpJob" |
| jobClass | 任务逻辑所在类的全路径或bean名称 | 是 | "com.ygsoft.ecp.component.scheduler.task.AnalysisTask" |
| jobMethod | 任务逻辑所在类的方法名 | 是 | "analysis" |
| jobUrl | HTTP地址，任务类型为远程请求时使用 | 否 | "http://example.com/api" |
| vipAddress | 标识组件归属的业务领域 | 是 | "/jt/mapp/sample" |
| jobDesc | 任务描述 | 是 | "调度测试-类及方法" |
| cronExpression | 调度时间的cron表达式 | 与repeatCount互斥 | "0 0/30 * * * ?" |
| startTime | 开始时间 | 是 | "2020-03-20" |
| endTime | 结束时间 | 是 | "2022-03-20" |
| priority | 优先级，1-10，10最高 | 是 | "9" |
| startDelay | 启动延时，单位秒 | 是 | "0" |
| repeatCount | 触发次数 | 与cronExpression互斥 | "0" |
| repeatInterval | 触发时间间隔，单位毫秒 | 与repeatCount配合使用 | "2000" |
| jobParameter | 远程请求时的post body参数 | 否 | "" |
| jobDataMap | 任务自定义参数（3.0及以下版本） | 否 | "" |
| jobDataDef | 任务自定义参数（3.0以上版本） | 否 | 见示例 |
| isCancel | 是否删除标识（V810以后版本） | 否 | "true" |

## 6. 使用注意事项

1. 调度方式选择：
  - 使用`cronExpression`可以设置基于时间的周期性调度
  - 使用`repeatCount`和`repeatInterval`可以设置基于次数的调度

2. 参数配置：
  - `jobDataMap`和`jobDataDef`是两种不同版本的参数配置方式，根据系统版本选择使用
  - 如果`jobDataMap`没有值，请务必去掉该项

3. 特殊配置：
  - 分钟调度需要添加`"jobParameter": "min=true"`，此参数需要部门经理审批
  - 设置`"isCancel": "true"`会删除上报的组件和调度任务（V810以后版本）
